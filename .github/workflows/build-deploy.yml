# Build, Test, and Deploy CloakBrowser

name: Build & Deploy

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_platform:
        description: 'Build platform'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - windows
          - macos

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'

jobs:
  # ---------------------------------------------------------------------------
  # Test on Ubuntu and macOS only
  # ---------------------------------------------------------------------------
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.10', '3.11', '3.12']
        exclude:
          - os: macos-latest
            python-version: '3.10'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]" pytest pytest-asyncio pytest-cov

      - name: Run tests
        run: |
          pytest tests/ -v --tb=short -m "not slow"
        env:
          COVERALLS_REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload coverage
        if: always()
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  # ---------------------------------------------------------------------------
  # JavaScript Tests
  # ---------------------------------------------------------------------------
  test-js:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: js/package-lock.json

      - name: Install dependencies
        working-directory: ./js
        run: npm ci

      - name: Run tests
        working-directory: ./js
        run: npm run test

      - name: TypeScript check
        working-directory: ./js
        run: npm run typecheck

      - name: Build
        working-directory: ./js
        run: npm run build

  # ---------------------------------------------------------------------------
  # Lint
  # ---------------------------------------------------------------------------
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Python lint
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install ruff
        run: pip install ruff
      - name: Run ruff
        run: ruff check cloakbrowser/ tests/

  # ---------------------------------------------------------------------------
  # Build Windows Binary (win32-x64)
  # ---------------------------------------------------------------------------
  build-windows:
    needs: [lint]
    runs-on: windows-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Add depot_tools to PATH
        shell: pwsh
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git "$env:USERPROFILE\depot_tools"
          echo "$env:USERPROFILE\depot_tools" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Install Visual Studio Build Tools
        shell: pwsh
        run: |
          choco install visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools --add Microsoft.VisualStudio.Component.VC.Tools.x86.x64 --includeRecommended" -y

      - name: Fetch Chromium
        shell: pwsh
        env:
          DEPOT_TOOLS_WIN_TOOLCHAIN: 0
        run: |
          New-Item -ItemType Directory -Path chromium -Force
          Set-Location chromium
          & cmd /c "fetch --no-history chromium"
          Set-Location src
          gn gen out/Release --args="is_official_build=true is_debug=false target_os=`"win`" target_cpu=`"x64`""

      - name: Apply stealth patches
        shell: pwsh
        run: |
          $patchFiles = Get-ChildItem -Path ../patches/*.patch -ErrorAction SilentlyContinue
          if ($patchFiles) {
            foreach ($patch in $patchFiles) {
              git apply $patch.FullName
            }
          } else {
            Write-Host "No patches found, skipping..."
          }

      - name: Build Chromium
        shell: pwsh
        run: |
          Set-Location src
          & autoninja -C out/Release chrome

      - name: Package binary
        shell: pwsh
        run: |
          Set-Location src\out\Release
          tar -czvf ../../../cloakbrowser-win32-x64.tar.gz chrome.exe

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cloakbrowser-win32-x64
          path: cloakbrowser-win32-x64.tar.gz
          retention-days: 30

  # ---------------------------------------------------------------------------
  # Build macOS ARM64 Binary (darwin-arm64) - Manual trigger only
  # ---------------------------------------------------------------------------
  build-macos-arm64:
    needs: [lint]
    runs-on: macos-latest
    if: github.event_name == 'workflow_dispatch' && (github.event.inputs.build_platform == 'all' || github.event.inputs.build_platform == 'macos')
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install depot_tools
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git $HOME/depot_tools
          echo "$HOME/depot_tools" >> $GITHUB_PATH

      - name: Fetch Chromium
        run: |
          mkdir chromium && cd chromium
          fetch --no-history chromium
          cd src
          gn gen out/Release --args='is_official_build=true is_debug=false target_os="mac" target_cpu="arm64"'

      - name: Apply stealth patches
        run: |
          git apply ../patches/*.patch

      - name: Build Chromium
        run: |
          cd src
          autoninja -C out/Release chrome

      - name: Package binary
        run: |
          cd src/out/Release
          tar -czvf ../../../../cloakbrowser-darwin-arm64.tar.gz "Chromium.app"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cloakbrowser-darwin-arm64
          path: cloakbrowser-darwin-arm64.tar.gz
          retention-days: 30

  # ---------------------------------------------------------------------------
  # Build macOS x64 Binary (darwin-x64) - Manual trigger only
  # ---------------------------------------------------------------------------
  build-macos-x64:
    needs: [lint]
    runs-on: macos-13
    if: github.event_name == 'workflow_dispatch' && (github.event.inputs.build_platform == 'all' || github.event.inputs.build_platform == 'macos')
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install depot_tools
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git $HOME/depot_tools
          echo "$HOME/depot_tools" >> $GITHUB_PATH

      - name: Fetch Chromium
        run: |
          mkdir chromium && cd chromium
          fetch --no-history chromium
          cd src
          gn gen out/Release --args='is_official_build=true is_debug=false target_os="mac" target_cpu="x64"'

      - name: Apply stealth patches
        run: |
          git apply ../patches/*.patch

      - name: Build Chromium
        run: |
          cd src
          autoninja -C out/Release chrome

      - name: Package binary
        run: |
          cd src/out/Release
          tar -czvf ../../../../cloakbrowser-darwin-x64.tar.gz "Chromium.app"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cloakbrowser-darwin-x64
          path: cloakbrowser-darwin-x64.tar.gz
          retention-days: 30

  # ---------------------------------------------------------------------------
  # Publish to PyPI
  # ---------------------------------------------------------------------------
  publish-pypi:
    needs: [test, test-js, lint]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    environment: pypi
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build
        run: pip install build

      - name: Build package
        run: python -m build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}

  # ---------------------------------------------------------------------------
  # Publish to npm
  # ---------------------------------------------------------------------------
  publish-npm:
    needs: [test-js, lint]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    environment: npm
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Install deps
        working-directory: ./js
        run: npm ci

      - name: Build
        working-directory: ./js
        run: npm run build

      - name: Publish to npm
        working-directory: ./js
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ---------------------------------------------------------------------------
  # Create Release
  # ---------------------------------------------------------------------------
  release:
    needs: [publish-pypi, publish-npm]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
